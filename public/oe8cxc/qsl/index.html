<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QSO Card Generator</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        @media (max-width: 800px) {
            #qslCanvas {
                width: 100vw !important;
            }
        }

        .caps {
            text-transform: uppercase;
        }
    </style>
</head>

<body>
    <div class="container my-5">
        <h1 class="text-center">QSO Card Generator by OE8CXC</h1>
        <div class="row justify-content-center">
            <div class="col-md-8 canvas-container" style="display:flex;justify-content:center">
                <canvas id="qslCanvas" style="width:50vw"></canvas>
            </div>
        </div>
        <div class="row justify-content-center mt-3">
            <button id="downloadBtn" class="btn btn-primary">Download QSL Card</button>
        </div>
        <form class="mt-3 data">
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="callsign">Other Call</label>
                    <input type="text" class="form-control caps" id="callsign" placeholder="XYZ">
                </div>
                <div class="form-group col-md-6">
                    <label for="utcDateTime">UTC DATE/TIME (dd.mm.yyyy hh:mm)</label>
                    <input type="text" class="form-control" id="utcDateTime" placeholder="dd.mm.yyyy hh:mm">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-4">
                    <label for="frequency">Frequency MHz</label>
                    <input type="number" class="form-control" id="frequency" placeholder="Frequency MHz">
                </div>
                <div class="form-group col-md-4">
                    <label for="mode">Mode</label>
                    <input type="text" class="form-control caps" id="mode" placeholder="Mode">
                </div>
                <div class="form-group col-md-4">
                    <label for="rst">R-S-T</label>
                    <input type="text" class="form-control" id="rst" placeholder="R-S-T">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-4">
                    <label for="additional">Additional</label>
                    <textarea rows="2" class="form-control" id="additional" style="resize:none">
Thanks for the QSO
Best regards</textarea>
                </div>
                <div class="form-group col-md-4">
                    <label for="backgroundSelect">Select Background</label>
                    <select class="form-control" id="backgroundSelect">
                        <option value="goldeck1.jpg">Goldeck 1</option>
                        <option value="goldeck2.jpg">Goldeck 2</option>
                        <option value="millstatt.jpg">Millstättersee</option>
                        <option value="millstatt2.jpg">Millstättersee Sonnenuntergang</option>
                        <option value="staff1.jpg">Staff 1</option>
                        <option value="staff2.jpg">Staff 2</option>
                        <option value="kaesnudl.jpg">Kärntner Kasnudl</option>
                        <option value="kasperl.jpg">Kasperl</option>
                        <option value="piefke.jpg">Piefke</option>
                    </select>
                </div>
            </div>
        </form>
    </div>
    <script>
        const canvas = document.getElementById('qslCanvas');
        const context = canvas.getContext('2d');
        const qslImage = new Image();
        const backgroundImage = new Image();

        const SCALE_FACTOR = 0.4;

        qslImage.onload = function () {
            canvas.width = qslImage.width * SCALE_FACTOR;
            canvas.height = qslImage.height * SCALE_FACTOR;
            drawImage();
        };

        qslImage.src = "QSL-Karte.png";

        backgroundImage.onload = function () {
            drawImage();
        };

        document.getElementById('backgroundSelect').addEventListener('change', function () {
            backgroundImage.src = "./background/" + this.value;
        });

        function drawImage() {
            if (!qslImage.complete || !backgroundImage.complete) {
                return;
            }
            context.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);
            context.drawImage(qslImage, 0, 0, canvas.width, canvas.height);
            updateCanvas();
        }

        const padZero = (num) => num.toString().padStart(2, '0');

        function updateCanvas() {
            context.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);
            context.drawImage(qslImage, 0, 0, canvas.width, canvas.height);
            const callsign = document.getElementById('callsign').value;
            const utcDateTime = document.getElementById('utcDateTime').value;
            const frequency = document.getElementById('frequency').value;
            const mode = document.getElementById('mode').value;
            const rst = document.getElementById('rst').value;
            let additional = document.getElementById('additional').value;

            // Parse the date manually
            let dateObj;
            if (utcDateTime) {
                const parts = utcDateTime.split(' ');
                const datePart = parts[0].split('.');
                const timePart = parts[1].split(':');
                dateObj = new Date(datePart[2], datePart[1] - 1, datePart[0], timePart[0], timePart[1]);
            } else {
                dateObj = new Date();
            }

            const formattedDateTime =
                padZero(dateObj.getDate()) + '.' +
                padZero(dateObj.getMonth() + 1) + '.' +
                dateObj.getFullYear() + ' ' +
                padZero(dateObj.getHours()) + ':' +
                padZero(dateObj.getMinutes());

            context.font = 100 * SCALE_FACTOR + 'px Arial';
            context.textAlign = 'center';
            context.textBaseline = 'middle';
            context.fillStyle = 'black';

            // Define positions for each field based on the template
            const positions = {
                callsign: { x: 3368.3, y: 2026.3 },
                utcDateTime: { x: 2623.1, y: 2498.7 },
                frequency: { x: 3397.5, y: 2498.7 },
                mode: { x: 3905.7, y: 2498.7 },
                rst: { x: 4353.3, y: 2498.7 },
                additional: { x: 2026.9, y: 2759.6 }
            };

            // Draw each text field
            context.fillText(callsign.toUpperCase(), positions.callsign.x * SCALE_FACTOR, positions.callsign.y * SCALE_FACTOR);

            context.font = 80 * SCALE_FACTOR + 'px Arial';
            context.fillText(formattedDateTime, positions.utcDateTime.x * SCALE_FACTOR, positions.utcDateTime.y * SCALE_FACTOR);

            context.font = 100 * SCALE_FACTOR + 'px Arial';
            context.fillText(frequency, positions.frequency.x * SCALE_FACTOR, positions.frequency.y * SCALE_FACTOR);
            context.fillText(mode.toUpperCase(), positions.mode.x * SCALE_FACTOR, positions.mode.y * SCALE_FACTOR);
            context.fillText(rst, positions.rst.x * SCALE_FACTOR, positions.rst.y * SCALE_FACTOR);

            additional = additional.split("\n");

            context.textAlign = 'left';
            context.textBaseline = 'top';
            context.font = 'bold ' + 100 * SCALE_FACTOR + 'px Arial';

            context.fillText(additional[0] ?? "", positions.additional.x * SCALE_FACTOR, positions.additional.y * SCALE_FACTOR);
            context.fillText(additional[1] ?? "", positions.additional.x * SCALE_FACTOR, positions.additional.y * SCALE_FACTOR + (120 * SCALE_FACTOR));
        }

        $(".data input, .data textarea").on("input", function (e) {
            updateCanvas();
        });

        document.getElementById('downloadBtn').addEventListener('click', function () {
            const callsign = document.getElementById('callsign').value || 'XYZ';
            const utcDateTime = document.getElementById('utcDateTime').value;
            const datePart = utcDateTime ? utcDateTime.split(' ')[0].replace(/\./g, '-') : 'dd-mm-yyyy';
            const timePart = utcDateTime ? utcDateTime.split(' ')[1].replace(/:/g, '-') : 'hh-mm';
            const filename = `${callsign.toUpperCase()}.png`;

            const link = document.createElement('a');
            link.download = filename;
            link.href = canvas.toDataURL('image/png');
            link.click();
        });

        // Initial background load
        backgroundImage.src = "./background/goldeck1.jpg";

        document.addEventListener('DOMContentLoaded', function () {
            const utcDateTimeField = document.getElementById('utcDateTime');
            const now = new Date();

            const padZero = (num) => num.toString().padStart(2, '0');

            const formattedDateTime =
                padZero(now.getUTCDate()) + '.' +
                padZero(now.getUTCMonth() + 1) + '.' +
                now.getUTCFullYear() + ' ' +
                padZero(now.getUTCHours()) + ':' +
                padZero(now.getUTCMinutes());

            utcDateTimeField.value = formattedDateTime;
            updateCanvas(); // To update the canvas with the current date and time immediately
        });
    </script>
</body>

</html>