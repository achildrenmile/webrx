<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>WebRX Map</title>
  <meta property="og:image" content="/images/webrxAT.png">
  <link rel="stylesheet" href="./leaflet.css">

  <style>
    a {
      color: #007bff;
      text-decoration: none;
      transition: color 0.2s;
    }

    a:hover {
      color: #0056b3;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    header {
      width: 100%;
      height: 150px;
      background: linear-gradient(
        45deg,
        #1A1F2F,
        #232838,
        #2A3040,
        #232838,
        #1A1F2F
      );
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      position: relative;
      color: #fff;
      text-align: center;
      padding: 20px 0;
      flex-shrink: 0;
    }

    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    header::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(
        circle at top right,
        rgba(255, 255, 255, 0.03),
        transparent 50%
      );
    }

    header img {
      width: 150px;
    }

    header h1 {
      margin: 0;
      font-size: 12px;
    }

    main {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      padding-bottom: env(safe-area-inset-bottom);
    }

    #map {
      flex-grow: 1;
      height: 100%;
      width: 100%;
    }

    footer {
      text-align: center;
      padding: 10px 0;
      flex-shrink: 0;
      background: linear-gradient(
        45deg,
        #1A1F2F,
        #232838,
        #2A3040,
        #232838,
        #1A1F2F
      );
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      color: #ffffff;
      position: relative;
      padding-bottom: max(10px, env(safe-area-inset-bottom));
    }

    footer a {
      color: #00C6FF;
      text-decoration: none;
      transition: color 0.2s;
    }

    footer a:hover {
      color: #2EE59D;
    }

    footer::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(
        circle at top right,
        rgba(255, 255, 255, 0.03),
        transparent 50%
      );
      pointer-events: none;
    }

    .leaflet-marker-icon {
      border: 0 !important;
    }

    .leaflet-popup-content h3 {
      margin-bottom: 3px;
    }

    .leaflet-popup-content p {
      margin-top: 5px;
      margin-bottom: 5px;
    }

    @media (max-width: 600px) {
      header {
        padding: 10px 0;
        height: 80px;
      }

      header img {
        width: 80px;
      }

      header h1 {
        font-size: 12px;
      }

      footer {
        font-size: 14px;
        padding-left: 15px;
        padding-right: 15px;
        padding-bottom: max(100px, env(safe-area-inset-bottom));
      }
    }

    @media (min-width: 601px) and (max-width: 800px) {
      header {
        padding: 15px 0;
        height: 110px;
      }

      header img {
        width: 100px;
      }

      header h1 {
        font-size: 17px;
      }

      footer {
        font-size: 15px;
        padding-left: 15px;
        padding-right: 15px;
        padding-bottom: max(100px, env(safe-area-inset-bottom));
      }
    }
  </style>
</head>

<body>

<a>
  <header>
    <img src="images/webrxAT.png" alt="WebRX.at">
  </header>
</a>

  <main>
    <div id="map"></div>
  </main>

  <footer>
    <p>Connecting voices, bridging worlds - Amateur Radio Unites us all! If you want to add a RX let <a
        href="mailto:admins@webrx.at">us</a> know. You want to build one? Thanks to OE8CXC, here is a <a
        href="./docs/Anleitung.pdf" target="_blank">Quick start Guide</a>.
    <p>
    <p><a href="/imprint.htm" target="_blank">Imprint & Data protection(in German)</a>
  </footer>

  <script src="./leaflet.js"></script>

  <script>
    function initMap(locations) {
      var map = L.map('map').setView([47.6, 14.2], 7);

      var myAttrControl = L.control.attribution().addTo(map);
      myAttrControl.setPrefix(`<a href="https://leafletjs.com" title="A JavaScript library for interactive maps">
  <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="12" height="8" viewBox="0 0 12 8" class="leaflet-attribution-flag">
    <path fill="#ED2939" d="M0 0h12v3H0z"></path>
    <path fill="#FFFFFF" d="M0 3h12v2H0z"></path>
    <path fill="#ED2939" d="M0 5h12v3H0z"></path>
  </svg>
  Leaflet
</a>
`);

      // Use local tile proxy for OpenStreetMap tiles
      L.tileLayer('/tiles/{s}/{z}/{x}/{y}.png', {
        subdomains: ['a', 'b', 'c'],
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      locations.forEach(function (location) {
        var frequencyList = '';
        if (location.status === 2 && location.frequencies && location.frequencies.length > 0) {
          frequencyList = '<p><b>Frequencies (MHz):</b> ' +
            location.frequencies.join(', ')
            + "</p>"
        }

        var iconHtml, popupContent;

        let message;
        let color;
        switch (location.status) {
          case 0:
            message = "Offline";
            color = "red";
            break;
          case 1:
            message = "Not working properly";
            color = "orange";
            break;
          case 2:
            message = "Working and operational";
            color = "green";
            break;
        }

        iconHtml = `<div style="position: relative; height:100%; width:100%"><img style="height: 100%; width:100%" src="images/webrxstation.png"><div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: ${color}; opacity:0.4"></div></div>`;
        popupContent = `<h3>${location.name}</h3>
                          <p style="color: ${color};font-weight:bold;margin-bottom:10px">${message}</p>
                          <p><a href="${location.sdrlink}" target="_blank">Open WebRX</a></p>
                          ${location.status == 2 ? frequencyList : ""}
                          ${location.status != 0 ? `<p><b>Ping:</b> ${location.ping}ms</p>` : ""}
                          <p>${location.info}</p>`;

        var satelliteIcon = L.divIcon({
          html: iconHtml,
          iconSize: [32, 32],
          iconAnchor: [16, 32],
          popupAnchor: [0, -32]
        });

        var marker = L.marker([location.lat, location.lng], { icon: satelliteIcon }).addTo(map);
        marker.bindPopup(popupContent);
      });
    }

    function fetchSdrData() {
      return fetch('/api/sdrs')
        .then(response => response.json())
        .catch(error => {
          console.error('Error fetching SDR data:', error);
          return null;
        });
    }

    function fetchLocations() {
      return fetch('locations.json', { cache: "no-cache" })
        .then(response => response.json())
        .catch(error => {
          console.error('Error fetching locations:', error);
          return [];
        });
    }

    document.addEventListener('DOMContentLoaded', async function () {
      const sdrData = await fetchSdrData();
      const locations = await fetchLocations();

      if (sdrData && locations) {
        const locationsWithStatus = locations.map(location => {
          const sdrStatus = sdrData.sdr_status.find(sdr => sdr.id === location.id);
          return {
            ...location,
            status: sdrStatus ? sdrStatus.status : 0,
            ping: sdrStatus ? sdrStatus.ping : null,
            frequencies: sdrStatus ? sdrStatus.frequencies : []
          };
        });

        initMap(locationsWithStatus);
      }
    });
  </script>

</body>

</html>
